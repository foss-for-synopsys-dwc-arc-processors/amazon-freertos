##
#  embarc makefiles for AWS FreeRTOS
##

AWS_FREERTOS_MKS_ROOT = $(OSES_ROOT_DIR)/aws_freertos
AWS_FREERTOS_OUT_DIR = $(OUT_DIR)/aws_freertos

get_aws_relobjs = $(addprefix $(AWS_FREERTOS_OUT_DIR)/, $(patsubst $(AWS_FREERTOS_ROOT)/%,%, $(addsuffix .o, $(basename $(1)))))


#include freertos kernel
include $(AWS_FREERTOS_MKS_ROOT)/freertos.mk

ifdef AWS_FREERTOS_LIB_SEL
	override AWS_FREERTOS_LIB_SEL := $(strip $(AWS_FREERTOS_LIB_SEL))
	AWS_FREERTOS_LIB_SEL_SORTED = $(sort $(AWS_FREERTOS_LIB_SEL))
	AWS_FREERTOS_LIB_MKS = $(foreach AWS_FREERTOS_LIB, $(AWS_FREERTOS_LIB_SEL_SORTED), $(join $(AWS_FREERTOS_LIB)/, $(AWS_FREERTOS_LIB).mk))
	AWS_FREERTOS_LIB_INCLUDES = $(foreach AWS_FREERTOS_LIB_MK, $(AWS_FREERTOS_LIB_MKS), $(wildcard $(addprefix $(AWS_FREERTOS_MKS_ROOT)/, $(AWS_FREERTOS_LIB_MK))))
#	COMMON_COMPILE_PREREQUISITES += $(AWS_FREERTOS_LIB_INCLUDES)
	include $(AWS_FREERTOS_LIB_INCLUDES)
endif


# specific compile rules
# user can add rules to compile this library
# if not rules specified to this library, it will use default compiling rules

.SECONDEXPANSION:
$(AWS_FREERTOS_COBJS): $(AWS_FREERTOS_OUT_DIR)/%.o :$(AWS_FREERTOS_ROOT)/%.c $$(COMMON_COMPILE_PREREQUISITES)
	$(TRACE_COMPILE)
	$(Q)$(CC) -c $(COMPILE_OPT) $< -o $@

.SECONDEXPANSION:
$(AWS_FREERTOS_ASMOBJS): $(AWS_FREERTOS_OUT_DIR)/%.o :$(AWS_FREERTOS_ROOT)/%.s $$(COMMON_COMPILE_PREREQUISITES)
	$(TRACE_ASSEMBLE)
	$(Q)$(CC) -c $(ASM_OPT) $< -o $@

.SECONDEXPANSION:
$(AWS_FREERTOS_CXXOBJS): $(AWS_FREERTOS_OUT_DIR)/%.o :$(AWS_FREERTOS_ROOT)/%.cpp $$(COMMON_COMPILE_PREREQUISITES)
	$(TRACE_COMPILE)
	$(Q)$(CC) -c $(CXX_COMPILE_OPT) $< -o $@


# OS Definitions
OS_INCDIR += $(AWS_FREERTOS_INCDIR)
OS_CSRCDIR += $(AWS_FREERTOS_CSRCDIR)
OS_ASMSRCDIR += $(AWS_FREERTOS_ASMSRCDIR)

OS_CSRCS += $(AWS_FREERTOS_CSRCS)
OS_CXXSRCS += $(AWS_FREERTOS_CXXSRCS)
OS_ASMSRCS += $(AWS_FREERTOS_ASMSRCS)
OS_ALLSRCS += $(AWS_FREERTOS_CSRCS) $(AWS_FREERTOS_ASMSRCS) $(AWS_FREERTOS_CXXSRCS)

OS_COBJS += $(AWS_FREERTOS_COBJS)
OS_CXXOBJS += $(AWS_FREERTOS_CXXOBJS)
OS_ASMOBJS += $(AWS_FREERTOS_ASMOBJS)
OS_ALLOBJS += $(AWS_FREERTOS_OBJS)

OS_DEFINES += $(AWS_FREERTOS_DEFINES)
OS_DEPS += $(AWS_FREERTOS_DEPS)
OS_LIBS += $(AWS_FREERTOS_LIBS)